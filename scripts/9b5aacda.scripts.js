"use strict";var myApp=angular.module("ZedApp",["ngCookies","ngResource","ngSanitize","ngRoute","ngTouch","ui.router","ui.bootstrap","ngAnimate","pascalprecht.translate","LocalStorageModule","ZedAppControllers","ZedAppServices","ZedAppProviders"]).run(function(){FastClick.attach(document.body)}).config(["$stateProvider","$urlRouterProvider","guestStatusesProvider",function(a,b,c){b.otherwise("/login"),a.state("anonymous",{"abstract":!0,template:"<ui-view/>",controller:"MainCtrl"}).state("anonymous.login",{templateUrl:"views/login.html",controller:"LoginCtrl",url:"/login"}).state("anonymous.register",{templateUrl:"views/register.html",controller:"RegisterCtrl"}),a.state("user",{"abstract":!0,url:"",template:"<ui-view/>"}).state("user.events",{"abstract":!0,templateUrl:"views/events.html",controller:"EventsCtrl"}).state("user.events.main",{url:"/events",views:{navigation:{templateUrl:"views/partials/navigation.html",controller:"NavCtrl"},map:{templateUrl:"views/partials/map.html",controller:"MapCtrl"},"events-list":{templateUrl:"views/partials/events-list.html",controller:"EventsListCtrl"}}}),a.state("user.events.main.all",{url:"/all",data:{statusFilter:c.statuses().All.englishName}}).state("user.events.main.sitting",{url:"/sitting",data:{statusFilter:c.statuses().Sitting.englishName}}).state("user.events.main.ordered",{url:"/ordered",data:{statusFilter:c.statuses().Ordered.englishName}}).state("user.events.main.occasional",{url:"/occasional",data:{statusFilter:c.statuses().Occasional.englishName}}).state("user.events.main.alarms",{url:"/alarms",data:{}})}]);angular.module("ZedAppServices",[]).service("User",[function(){this.updateUserDetailes=function(a,b){this.username=a,this.sessionID=b,console.log("updated username "+a+" with sessionID "+b),this.notifyObservers(this.sessionID)};var a=[];this.registerObserverCallback=function(b){a.push(b)},this.notifyObservers=function(b){console.log("User notified observers of token update with token "+b),angular.forEach(a,function(a){a(b)})}}]),angular.module("ZedAppServices").service("Authentication",["$http","$state","$q","localStorageService","User","SERVER_URL","LOGIN_URL",function(a,b,c,d,e,f,g){this.login=function(b,d){console.log("Logging in for "+b+" with Pass "+d);var e=f+g,h={Authorization:"Basic "+btoa(b+":"+d),"Content-type":"application/json; charset=utf-8"},i=c.defer();return a({method:"POST",url:e,headers:h,data:""}).success(function(a){console.log(a),i.resolve(a)}).error(function(a){console.log(a),i.reject(a)}),i.promise},this.retrieveUserAuth=function(){var a=d.get("zedAuthToken"),b=d.get("zedUsername");console.log("retrieved AuthToken "+a);var c={authToken:a,username:b};return c};var h=function(b){a.defaults.headers.common.sessionID=b,console.log("updated sessionID Header with token "+b)};e.registerObserverCallback(h)}]),angular.module("ZedAppServices").service("Events",["$http","$q","User","EventStatuses","SERVER_URL","GET_EVENTS_URL","SET_EVENT_URL",function(a,b,c,d,e,f,g){var h=null,i=null;this.createEvent=function(){var a=new Object;return a.id_event_status=d.New.identifierCode,a.date=moment().format("DD/MM/YYYY"),a.start_time=moment().format("HH:mm:ss"),a.client_name="Default",a.seats=0,a.phone="",a.is_active=!0,console.log("created event with date "+a.date+" and time: "+a.start_time),a},this.getEvents=function(c,d,g){var j="06:00",k="02:00";console.log("Getting events for: "+c+", "+j+", "+k);var l=e+f,m=b.defer();return a.post(l,{StartTime:j,EndTime:k,DateSTR:c,WarnOnCollisions:d,WarnOnLateOrOpen:g}).success(function(a){console.log("Events fetching successful with data : "+JSON.stringify(a,null,4));var b=JSON.parse(a.d);h=b.events,i=b.collisions,m.resolve({events:h,collisions:i})}).error(function(a){console.error(a),m.reject(a)}),m.promise},this.setEvent=function(c){console.log("Setting new Event");var d=e+g,f={eventToSave:{date:c.date,start_time:c.start_time,id_event_status:c.id_event_status,event_type:c.event_type,client_name:c.client_name,guest_count:c.guest_count,seats:c.seats,phone:c.phone,email:c.email,contact_man:c.contact_man,comments:c.comments,const_comment:c.const_comment,is_active:c.is_active}};console.log(JSON.stringify(f,null,4));var j=b.defer();return a.post(d,f).success(function(a){console.log(a),j.resolve({events:h,collisions:i})}).error(function(a){console.error(a),j.reject(a)}),j.promise}}]),angular.module("ZedApp").constant("SERVER_URL","http://zed.streetwise.co.il:8085/").constant("SESSION_TOKEN_KEY","sessionID").constant("USER_COOKIE_NAME","zUserInfo").constant("LOGIN_URL","login/default.aspx/gettoken").constant("GET_EVENTS_URL","ng_Events/EventsService.asmx/GetEvents").constant("GET_SINGLE_DAY_URL","HoursManagement/HoursService.asmx/GetSingleDay").constant("GET_SHIFT_STATS_URL","ng_Events/EventsService.asmx/GetShiftStats").constant("GET_MAP_URL","ng_Events/EventsService.asmx/GetMap").constant("SET_EVENT_URL","ng_Events/EventsService.asmx/SetEvent").constant("TIME_FILTER_CHANGED","TimeFilterChanged").constant("DATE_FILTER_CHANGED","DateFilterChanged").constant("SHIFT_FILTER_CHANGED","ShiftFilterChanged"),angular.module("ZedAppServices").service("EventStatuses",[function(){return{Ordered:{identifierCode:"10",color:"lightblue",englishName:"Ordered",hebrewName:"מוזמן"},Confirmation:{identifierCode:"20",color:"green",englishName:"Confirmation",hebrewName:"אישור"},Sitting:{identifierCode:"30",color:"red",englishName:"Sitting",hebrewName:"יושב"},Bill:{identifierCode:"40",color:"orange",englishName:"Bill",hebrewName:"חשבון"},Occasional:{identifierCode:"50",color:"yellow",englishName:"Occasional",hebrewName:"מזדמן"},Finished:{identifierCode:"60",color:"gray",englishName:"Finished",hebrewName:"סיים"},Canceled:{identifierCode:"70",color:"lightgray",englishName:"Canceled",hebrewName:"בוטל"},New:{identifierCode:"80",color:"violet",englishName:"New",hebrewName:"חדש"}}}]),angular.module("ZedAppServices").service("Shifts",["$q","$http","ShiftsTimes","SERVER_URL","GET_SINGLE_DAY_URL",function(a,b,c,d,e){function f(a){var b=a.business_shifts;if(b)for(var d="HH:mm:ss",e=60,f=0;f<b.length;f++){var h=b[f];h.times=c.generateTimes(h.startTime,h.endTime,e,d),g.push(h)}}this.shiftsMinutes=function(){return["00","15","30","45"]};var g=[];this.shifts=function(){return g},this.getDay=function(c){var g=d+e,h=a.defer();return console.log("Getting shifs for date "+c),console.log(b.defaults.headers.common.sessionID),b.post(g,{dateSTR:c}).success(function(a){console.log("Shifts Fetching successful with data: "+JSON.stringify(a,null,4)),f(JSON.parse(a.d)),h.resolve(a)}).error(function(a){console.error(a),h.reject(a)}),h.promise}}]),angular.module("ZedAppServices").service("ShiftsTimes",[function(){this.generateTimes=function(a,b,c,d){console.log("Generating times for shift "+a+" "+b);for(var e=moment(a,d),f=moment(b,d),g=Math.abs(f.diff(e,"Minutes")),h=g/c,i=[],j=0;h+1>j;j++){var k=moment(e).add("m",j*c),l=k.format(d);l=l.substring(0,l.indexOf(":")),i.push(l)}return i}}]),angular.module("ZedAppServices").service("DataTester",[function(){this.tables=function(){return tables=[{type:"table",text:"10",x:80,y:50,width:60,height:160},{type:"chair",text:"11",cx:55,cy:70,r:15},{type:"chair",text:"12",cx:55,cy:110,r:15},{type:"chair",text:"13",cx:55,cy:150,r:15},{type:"chair",text:"14",cx:55,cy:190,r:15},{type:"chair",text:"15",cx:165,cy:190,r:15},{type:"chair",text:"16",cx:165,cy:150,r:15},{type:"chair",text:"17",cx:165,cy:110,r:15},{type:"chair",text:"18",cx:165,cy:70,r:15},{type:"table",text:"20",x:260,y:50,width:60,height:160},{type:"chair",text:"21",cx:235,cy:70,r:15},{type:"chair",text:"22",cx:235,cy:110,r:15},{type:"chair",text:"23",cx:235,cy:150,r:15},{type:"chair",text:"24",cx:235,cy:190,r:15},{type:"chair",text:"25",cx:345,cy:190,r:15},{type:"chair",text:"26",cx:345,cy:150,r:15},{type:"chair",text:"27",cx:345,cy:110,r:15},{type:"chair",text:"28",cx:345,cy:70,r:15},{type:"table",text:"30",x:440,y:50,width:60,height:160},{type:"chair",text:"31",cx:415,cy:70,r:15},{type:"chair",text:"32",cx:415,cy:110,r:15},{type:"chair",text:"33",cx:415,cy:150,r:15},{type:"chair",text:"34",cx:415,cy:190,r:15},{type:"chair",text:"35",cx:525,cy:190,r:15},{type:"chair",text:"36",cx:525,cy:150,r:15},{type:"chair",text:"37",cx:525,cy:110,r:15},{type:"chair",text:"38",cx:525,cy:70,r:15},{type:"table",text:"40",x:620,y:50,width:60,height:160},{type:"chair",text:"41",cx:595,cy:70,r:15},{type:"chair",text:"42",cx:595,cy:110,r:15},{type:"chair",text:"43",cx:595,cy:150,r:15},{type:"chair",text:"44",cx:595,cy:190,r:15},{type:"chair",text:"45",cx:705,cy:190,r:15},{type:"chair",text:"46",cx:705,cy:150,r:15},{type:"chair",text:"47",cx:705,cy:110,r:15},{type:"chair",text:"48",cx:705,cy:70,r:15},{type:"table",text:"50",x:800,y:50,width:60,height:160},{type:"chair",text:"51",cx:775,cy:70,r:15},{type:"chair",text:"52",cx:775,cy:110,r:15},{type:"chair",text:"53",cx:775,cy:150,r:15},{type:"chair",text:"54",cx:775,cy:190,r:15},{type:"chair",text:"55",cx:885,cy:190,r:15},{type:"chair",text:"56",cx:885,cy:150,r:15},{type:"chair",text:"57",cx:885,cy:110,r:15},{type:"chair",text:"58",cx:885,cy:70,r:15},{type:"table",text:"60",x:980,y:50,width:60,height:160},{type:"chair",text:"61",cx:955,cy:70,r:15},{type:"chair",text:"62",cx:955,cy:110,r:15},{type:"chair",text:"63",cx:955,cy:150,r:15},{type:"chair",text:"64",cx:955,cy:190,r:15},{type:"chair",text:"65",cx:1065,cy:190,r:15},{type:"chair",text:"66",cx:1065,cy:150,r:15},{type:"chair",text:"67",cx:1065,cy:110,r:15},{type:"chair",text:"68",cx:1065,cy:70,r:15},{type:"table",text:"70",x:960,y:280,width:100,height:100},{type:"table",text:"80",x:960,y:400,width:100,height:100},{type:"table",text:"1",x:40,y:400,width:60,height:60},{type:"table",text:"2",x:40,y:300,width:60,height:60},{type:"chair",text:"3",cx:200,cy:500,r:15},{type:"chair",text:"4",cx:200,cy:460,r:15},{type:"chair",text:"5",cx:200,cy:420,r:15},{type:"chair",text:"6",cx:200,cy:380,r:15},{type:"chair",text:"7",cx:200,cy:340,r:15},{type:"chair",text:"8",cx:200,cy:300,r:15},{type:"chair",text:"Order",cx:1100,cy:600,r:20}]}}]),angular.module("ZedApp.Directives",[]).directive("date-picker",function(){return{require:"ngModel",link:function(a,b,c,d){$(b).datepicker({onSelect:function(b){console.log("asdasdsadasdas"),a.$apply(function(){d.$setViewValue(b)})}})}}}),angular.module("ZedAppProviders",[]).provider("guestStatuses",function a(){this.statuses=function(){return{All:{identifierCode:999,hebrewName:"הכול",englishName:"All",showStatus:["10","20","30","40","50","60","70","80","222"]},Sitting:{identifierCode:100,hebrewName:"יושב",englishName:"Sitting",showStatus:["30","40"]},Ordered:{identifierCode:101,hebrewName:"מוזמן",englishName:"Ordered",showStatus:["10","20"]},Occasional:{identifierCode:200,hebrewName:"מזדמן",englishName:"Occasional",showStatus:["50"]}}},this.$get=function(){return new a}}),angular.module("ZedAppFilters",["ZedAppProviders"]).filter("eventStatus",["guestStatuses",function(a){return function(b,c){if("undefined"==typeof b||null===b||null==c)return b;var d=[],e=null;switch(c){case a.statuses().Sitting.englishName:e=a.statuses().Sitting.showStatus;break;case a.statuses().Ordered.englishName:e=a.statuses().Ordered.showStatus;break;case a.statuses().Occasional.englishName:e=a.statuses().Occasional.showStatus;break;case a.statuses().All.englishName:e=a.statuses().All.showStatus}for(var f=0;f<b.length;f++){var g=b[f].id_event_status.toString();-1!=e.indexOf(g)&&d.push(b[f])}return d}}]),angular.module("ZedAppFilters").filter("time",[function(){return function(a,b,c){if(console.log("Filtering times for times "+b+" and Shift "+c),"undefined"==typeof a||null===a)return a;var d=2,e="HH:mm:ss",f="HH:mm",g=moment(b,f),h=[];if(null===b)for(l=0;l<a.length;l++){var i=a[l].start_time.toString(),j=i.split(":"),k=j[0];-1!=c.times.indexOf(k)&&h.push(a[l])}else for(var l=0;l<a.length;l++){var m=a[l].start_time.toString(),n=moment(m,e),o=Math.abs(n.diff(g,"Hours"));d>o&&h.push(a[l])}return h}}]),angular.module("ZedAppControllers",["ZedAppServices","ZedAppFilters"]).controller("MainCtrl",["$scope","$state","User","Authentication",function(a,b,c){b.go(c.sessionID?"user.events.main.all":"anonymous.login")}]),angular.module("ZedAppControllers").controller("LoginCtrl",["$scope","$state","localStorageService","User","Authentication",function(a,b,c,d,e){a.isLoading=!1,a.isAuthenticated=!1,a.loginError=null,console.log(d),a.login=function(){a.isLoading=!0;var f=e.login(a.username,a.password);f.then(function(e){console.log("Successful login"),d.updateUserDetailes(a.username,e.d),c.add("zedAuthToken",d.sessionID),c.add("zedUsername",a.username),a.isLoading=!1,a.isAuthenticated=!0,b.go("user.events.main.all")},function(b){console.log("Error in login"),a.isLoading=!1,a.loginError=b})},a.hasErrors=function(){return a.loginError}}]),angular.module("ZedAppControllers").controller("EventsCtrl",["User","Authentication",function(a,b){var c=b.retrieveUserAuth();a.updateUserDetailes(c.username,c.authToken)}]),angular.module("ZedAppControllers").controller("MapCtrl",["$window","$scope","DataTester",function(a,b,c){function d(a,b){function c(){}c.prototype=b.prototype,a.prototype=new c,a.prototype.constructor=a,a.superclass=b}function e(){var a=this;this.width=b.graph.width,this.height=b.graph.height,this.scale=b.graph.scale,this.offsetX=0,this.offsetY=0,this.paper=Raphael("raphael-map",this.width,this.height),this.bg=this.paper.rect(0,0,this.width,this.height),this.bg.attr("fill","#d0d0d0"),this.bg.attr("stroke",!1),this.bg.drag(function(b,c){a.offsetX=a.startOffsetX-b*a.scale,a.offsetY=a.startOffsetY-c*a.scale,a.applyViewBox()},function(){a.startOffsetX=a.offsetX,a.startOffsetY=a.offsetY}),$(this.paper.canvas).on("mousewheel",function(b){var c=b.originalEvent;return a.setScale(Math.pow(1/1.003,c.deltaY),c.clientX,c.clientY),!1})}function f(a){$.extend(this,a),this.form=this.getShape(),this.form.attr("fill","white"),this.form.attr("stroke",!1),this.label=this.scheme.paper.print(0,0,this.text,"Museo 500",14),this.positionText(),this.behavior=this.getShape(),"Order"==a.text?(this.behavior.attr("fill","red"),this.behavior.attr("fill-opacity",.1),this.behavior.attr("stroke","black"),this.behavior.mouseup(this.Order)):(this.behavior.attr("fill","white"),this.behavior.attr("fill-opacity",.1),this.behavior.attr("stroke",!1),this.behavior.drag(this.onDrag,this.onDragStart,null,this,this),this.behavior.mouseup(this.onMouseUp))}function g(a){if(0!=a.behavior.attrs.stroke){a.behavior.attr("stroke",!1),alert("Table: "+a.text+" has been removed");var b=n.indexOf(a);n.splice(b,1)}else a.behavior.attr("stroke","red"),alert("Table: "+a.text+" has been chosen"),n.push(a)}function h(){h.superclass.apply(this,arguments)}function j(){j.superclass.apply(this,arguments)}var k=[],l=[],m=[],n=[];b.graph={width:1200,height:600,scale:2},b.mapScheme=null,e.prototype.setScale=function(a,b,c){var d=this.scale*a;.2>d?d=.2:d>3&&(d=3),a=d/this.scale,this.scale=d,this.offsetX-=(a-1)*b*this.scale,this.offsetY-=(a-1)*c*this.scale,this.applyViewBox()},e.prototype.applyViewBox=function(){this.paper.setViewBox(this.offsetX,this.offsetY,this.width*this.scale,this.height*this.scale)},f.prototype.positionText=function(){var a=this.label.getBBox(),b=this.form.getBBox(),c={x:b.x+b.width/2-a.width/2,y:b.y+b.height/2-a.height/2};this.label.attr("path",Raphael.transformPath(this.label.attr("path"),"T"+(c.x-a.x)+","+(c.y-a.y)))},f.prototype.getShape=function(){},f.prototype.onDrag=function(){},f.prototype.onDragStart=function(){},f.prototype.onMouseDown=function(){},f.prototype.onMouseUp=function(){},f.prototype.Order=function(){},d(h,f),h.prototype.getShape=function(){return this.scheme.paper.circle(this.cx,this.cy,this.r)},h.prototype.onDrag=function(a,b){this.form.attr({cx:this.ox+a*this.scheme.scale,cy:this.oy+b*this.scheme.scale}),this.behavior.attr({cx:this.ox+a*this.scheme.scale,cy:this.oy+b*this.scheme.scale}),this.positionText(),this.scheme.paper.safari()},h.prototype.onDragStart=function(){this.ox=this.behavior.attr("cx"),this.oy=this.behavior.attr("cy")},h.prototype.onMouseDown=function(){},h.prototype.onMouseUp=function(){for(var a=0;a<k.length;a++)k[a].behavior.id==this.id&&g(k[a])},h.prototype.Order=function(){for(var a="",b=0;b<n.length;b++)a+=n[b].text+",";alert("Ordering tables: "+a)},d(j,f),j.prototype.getShape=function(){return this.scheme.paper.rect(this.x,this.y,this.width,this.height,3)},j.prototype.onDrag=function(a,b){this.form.attr({x:this.ox+a*this.scheme.scale,y:this.oy+b*this.scheme.scale}),this.behavior.attr({x:this.ox+a*this.scheme.scale,y:this.oy+b*this.scheme.scale}),this.positionText(),this.scheme.paper.safari()},j.prototype.onDragStart=function(){this.ox=this.behavior.attr("x"),this.oy=this.behavior.attr("y")},j.prototype.onMouseUp=function(){for(var a=0;a<k.length;a++)k[a].behavior.id==this.id&&g(k[a])},b.onload=function(){b.mapScheme=new e,objects=c.tables(),b.mapScheme.setScale(1,1,1);var a=b.mapScheme;for(i=0;i<objects.length;i++)if("table"===objects[i].type){var d=new j($.extend(objects[i],{scheme:a}));k.push(d),l.push(d)}else if("chair"===objects[i].type){var f=new h($.extend(objects[i],{scheme:a}));k.push(f),m.push(f)}var g=a.paper.path("M225,520 L225,280 L365,280 L365,320 L265,320 L265,520 Z");g.attr({stroke:"black",fill:"#d0d0d0"})},b.onload()}]),angular.module("ZedAppControllers").controller("EventsListCtrl",["$scope","$state","$modal","Events","EventStatuses","User","Shifts","DATE_FILTER_CHANGED","TIME_FILTER_CHANGED","SHIFT_FILTER_CHANGED",function(a,b,c,d,e,f,g,h,i,j){a.statusFilter=b.current.data.statusFilter,a.eventStatuses=e,a.getEvents=function(b,c,e){var f=d.getEvents(b,c,e);f.then(function(b){a.isLoading=!1,a.events=b.events,a.collisions=b.collisions},function(){console.log("Error in fetching Events"),a.isLoading=!1})},a.setEvent=function(a){var b=d.setEvent(a);b.then(function(){a.isExpanded=!1},function(){console.log("Error in fetching Events")})},a.addEvent=function(){a.events||(a.events=[]);var b=d.createEvent();a.events.push(b)},a.deleteEvent=function(b){if(a.events){var c=a.events.indexOf(b);c>-1&&a.events.splice(c,1)}},a.$on("$stateChangeStart",function(b,c){a.statusFilter=c.data.statusFilter}),a.$on(h,function(){}),a.$on(i,function(b,c){a.currentTime=c}),a.$on(j,function(b,c){a.currentShift=c}),a.openModal=function(b){var d=c.open({templateUrl:"views/partials/modalAlert.html",controller:"ModalCtrl"});d.result.then(function(){a.deleteEvent(b)},function(){})};var k=moment().format("DD/MM/YYYY"),l=!0,m=!1;a.getEvents(k,l,m)}]),angular.module("ZedAppControllers").controller("TimesCtrl",["$scope","$rootScope","$state","$q","$http","Events","Shifts","TIME_FILTER_CHANGED","SHIFT_FILTER_CHANGED",function(a,b,c,d,e,f,g,h,i){a.shiftsMinutes=g.shiftsMinutes(),a.currentDate=moment().format("DD/MM/YYYY"),a.currentTime=null,a.currentMinutes=a.shiftsMinutes[0],a.currentHour=null,a.$watch("currentDate",function(a){b.$broadcast(DATE_FILTER_CHANGED,a)}),a.$watch("currentTime",function(a){b.$broadcast(h,a)}),a.$watch("currentShift",function(a){void 0!=a&&console.log("currentShift changed to "+a.name+", Broadcasting"),b.$broadcast(i,a)}),a.timeChanged=function(){a.currentTime=null===a.currentHour?null:a.currentHour+":"+a.currentMinutes,console.log(a.currentTime)};var j="28/12/2013";0===g.shifts().length&&(console.log("I HAVE CREATED A SHIFTS REQUEST!!!!"),g.getDay(j).then(function(){a.shifts=g.shifts(),a.currentShift=a.shifts[1],a.isLoading=!1},function(){console.log("Error in fetching Shifts"),a.isLoading=!1}))}]),angular.module("ZedAppControllers").controller("NavCtrl",["$scope","$rootScope","Shifts","DATE_FILTER_CHANGED","TIME_FILTER_CHANGED","SHIFT_FILTER_CHANGED",function(a){a.nowDateDataFormated=function(){return moment(a.currentDate,"DD/MM/YYYY").format("DD/MM/YYYY")},a.nowTimeDataFormated=function(){return moment().format("HH:mm")},a.open=function(b){b.preventDefault(),b.stopPropagation(),a.opened=!0},a.dateOptions={"year-format":"'yy'","starting-day":1},a.format="yyyy/MM/dd"}]),angular.module("ZedAppControllers").controller("ModalCtrl",["$scope","$modalInstance",function(a,b){a.deleteEvent=function(){b.close(!0)},a.cancel=function(){b.dismiss("cancel")}}]);